# 远程桌面状态监控服务

这是一个用于监控Windows远程桌面连接状态的Web服务。当有用户通过远程桌面连接到这台电脑时，您可以通过Web界面查看连接状态和用户信息。

## 功能特性

- 🔍 **实时检测**: 自动检测远程桌面连接状态
- 👥 **用户监控**: 显示当前远程桌面连接的用户信息
- 🌐 **Web界面**: 美观的Web界面显示当前状态
- 📊 **历史记录**: 记录连接和断开的历史
- 🔄 **自动刷新**: 每10秒自动更新状态
- 📱 **响应式设计**: 支持手机和电脑访问

## 安装和运行

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 运行服务

```bash
python main.py
```

### 3. 访问服务

打开浏览器访问: http://localhost:51472

## API接口

- `GET /` - 主页面
- `GET /api/status` - 获取当前状态
- `GET /api/history` - 获取连接历史
- `GET /api/users` - 获取远程桌面连接用户
- `GET /api/force_check` - 强制检查状态

## 检测原理

服务使用基于网络连接的检测方法，确保准确性：

1. **端口连接检测**: 使用 `netstat -an` 检查端口43389的ESTABLISHED连接
2. **进程信息获取**: 使用 `netstat -ano` 获取连接对应的进程ID和名称
3. **IP地址解析**: 提取远程连接的IP地址信息
4. **连接状态验证**: 验证连接状态为 `ESTABLISHED` 的RDP连接
5. **环境变量补充**: 检查当前用户的 `SESSIONNAME` 环境变量作为补充
6. **状态确认机制**: 状态变化时进行二次确认，避免误判

## 使用场景

- **办公室共享电脑**: 监控是否有用户通过远程桌面使用电脑
- **服务器监控**: 查看是否有用户远程连接到服务器
- **家庭电脑**: 了解是否有用户远程使用电脑
- **安全监控**: 检测远程桌面连接状态和来源IP
- **工作状态通知**: 让其他人知道您正在远程使用电脑
- **网络监控**: 监控RDP端口43389的连接状态

## 注意事项

- 需要管理员权限才能访问某些系统信息
- 服务默认运行在51472端口
- 支持局域网内其他设备访问
- 建议在防火墙中开放相应端口
- 如果状态显示不准确，可以使用"强制检查"按钮
- 服务会自动进行状态确认，避免误判

## 自定义配置

您可以通过修改 `main.py` 中的以下参数来自定义服务：

- 端口号: 修改 `app.run(port=51472)`
- 检查间隔: 修改 `time.sleep(5)` 中的数值
- 历史记录数量: 修改 `self.connection_history[-50:]` 中的数值
