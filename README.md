# WhoIsHere - 远程桌面状态监控服务

监控外部用户通过远程桌面连接到当前电脑的状态，支持系统托盘运行和Web界面查看。

## 功能特性

- 🔍 **实时检测**: 自动检测端口43389的远程桌面连接
- 🌐 **Web界面**: 美观的Web界面显示连接状态和IP地址
- 📱 **系统托盘**: 最小化到系统托盘，支持后台运行
- 🔄 **自动刷新**: 每30秒自动更新状态
- 🎯 **精确检测**: 基于网络连接状态，准确可靠

## 快速开始

### 1. 安装依赖
```bash
pip install -r requirements.txt
```

### 2. 启动服务

#### 方式一：前台运行（推荐新手）
- 双击 `WhoIsHere.bat`
- 会显示CMD窗口，可以查看启动信息
- 关闭窗口后服务继续在托盘运行

#### 方式二：后台运行（推荐日常使用）
- 双击 `run_service.bat`
- 完全静默运行，无窗口干扰
- 服务在系统托盘运行

### 3. 访问服务
打开浏览器访问: http://localhost:51472

## 使用说明

### 系统托盘图标
- **绿色图标**: 没有外部用户远程连接
- **红色图标**: 有外部用户正在远程连接
- **右键菜单**:
  - 状态 - 查看当前连接状态
  - 打开Web界面 - 自动打开浏览器
  - 退出 - 停止服务

### Web界面功能
- 实时状态显示
- 连接IP地址信息
- 连接历史记录
- 强制检查功能

## 技术原理

### 检测方法
1. **端口连接检测**: 使用 `netstat -an` 检查端口43389的ESTABLISHED连接
2. **进程信息获取**: 使用 `netstat -ano` 获取连接对应的进程ID和名称
3. **IP地址解析**: 提取远程连接的IP地址信息
4. **连接状态验证**: 验证连接状态为 `ESTABLISHED` 的RDP连接
5. **状态确认机制**: 状态变化时进行二次确认，避免误判

### 端口说明
- **检测端口**: 43389 (远程桌面连接端口)
- **服务端口**: 51472 (Web服务端口)

## 文件说明

```
whoishere/
├── main.py              # 主程序文件
├── WhoIsHere.bat        # Windows前台启动脚本
├── run_service.bat      # Windows后台启动脚本
├── start.sh             # Linux/Mac启动脚本
├── requirements.txt     # Python依赖包
└── README.md           # 说明文档
```

## 使用场景

- **办公室共享电脑**: 监控是否有外部用户通过远程桌面使用电脑
- **服务器监控**: 查看是否有外部用户远程连接到服务器
- **家庭电脑**: 了解是否有外部用户远程使用电脑
- **安全监控**: 检测外部远程桌面连接状态和来源IP地址
- **工作状态通知**: 让其他人知道有外部用户正在远程使用电脑

## 注意事项

- 需要管理员权限才能访问某些系统信息
- 服务默认运行在51472端口
- 支持局域网内其他设备访问
- 建议在防火墙中开放相应端口
- 只能检测到连接的IP地址，无法获取具体用户名
- 不检测当前用户，只检测来自外部IP的远程连接

## 故障排除

### 服务无法启动
1. 检查Python环境是否正确安装
2. 检查虚拟环境是否激活
3. 检查依赖包是否安装完整

### 无法检测到连接
1. 确认远程桌面连接使用的是端口43389
2. 检查防火墙设置
3. 使用"强制检查"功能

### 托盘图标不显示
1. 检查系统托盘设置
2. 重启服务
3. 检查依赖包pystray是否正确安装

## 自定义配置

您可以通过修改 `main.py` 中的以下参数来自定义服务：

- 端口号: 修改 `app.run(port=51472)`
- 检查间隔: 修改 `time.sleep(30)` 中的数值
- 检测端口: 修改代码中的 `43389` 端口号

## 许可证

MIT License
